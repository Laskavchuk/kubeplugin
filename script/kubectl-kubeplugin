#!/bin/bash
set -euo pipefail


NAMESPACE=${1:-default}
RESOURCE_TYPE=${2:-pods}


OUTPUT=$(kubectl top $RESOURCE_TYPE -n "$NAMESPACE" --no-headers 2>/dev/null || true)

if [[ -z "$OUTPUT" ]]; then
  echo "Не вдалося отримати статистику для ресурсу '$RESOURCE_TYPE' у namespace '$NAMESPACE'"
  echo "Переконайтесь, що metrics-server встановлено."
  exit 1
fi

echo "Resource, Namespace, Name, CPU, Memory"

while read -r line; do
  NAME=$(echo "$line" | awk '{print $1}')
  CPU=$(echo "$line" | awk '{print $2}')
  MEMORY=$(echo "$line" | awk '{print $3}')
  echo "$RESOURCE_TYPE, $NAMESPACE, $NAME, $CPU, $MEMORY"
done <<< "$OUTPUT"